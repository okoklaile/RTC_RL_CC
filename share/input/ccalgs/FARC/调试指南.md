# FARC å¸¦å®½ä¼°è®¡å™¨è°ƒè¯•æŒ‡å—

## ğŸ” é—®é¢˜è¯Šæ–­ï¼šå¸¦å®½ä¼°è®¡è¿”å› 0

### åŸå› åˆ†æ
æ ¹æ®æ—¥å¿— `webrtc_FARC.log`ï¼Œå‘ç°å¸¦å®½ä¼°è®¡ä¸€ç›´è¿”å› 0ï¼š
```
Send back BWE estimation: 0 at time: 1376825955
Send back BWE estimation: 0 at time: 1376825956
```

### è°ƒè¯•æ–¹æ³•

## æ–¹æ³• 1ï¼šå¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆæ¨èï¼‰

### 1.1 ä¿®æ”¹ demo.py ä»¥æŸ¥çœ‹æ—¥å¿—

åœ¨ `demo.py` çš„ç¬¬ 66 è¡Œï¼Œæ‰¾åˆ°ï¼š
```python
subprocess.run(command, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
```

**æ”¹ä¸ºï¼ˆä¿ç•™ stderr ä»¥æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯ï¼‰ï¼š**
```python
subprocess.run(command, check=True, stdout=subprocess.DEVNULL)  # ç§»é™¤ stderr=subprocess.DEVNULL
```

### 1.2 è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨è°ƒè¯•

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```bash
FARC_DEBUG=1
```

æˆ–è€…åœ¨è¿è¡Œæ—¶è®¾ç½®ï¼š
```bash
export FARC_DEBUG=1
python3 demo.py
```

### 1.3 è°ƒè¯•è¾“å‡ºå†…å®¹

å¯ç”¨è°ƒè¯•åï¼Œä½ å°†çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š

```
[FARC DEBUG] åˆå§‹åŒ– FARC ä¼°è®¡å™¨ï¼Œstep_time=60ms
[FARC DEBUG] æ¨¡å‹è·¯å¾„: /path/to/fast_and_furious_model.onnx
[FARC DEBUG] æ¨¡å‹æ–‡ä»¶å­˜åœ¨: True
[FARC] åŠ è½½ ONNX æ¨¡å‹: /path/to/fast_and_furious_model.onnx
[FARC] å¯ç”¨çš„æ‰§è¡Œæä¾›è€…: ['CPUExecutionProvider']
[FARC] æ¨¡å‹åŠ è½½æˆåŠŸï¼
[FARC DEBUG] åˆå§‹åŒ–å®Œæˆ

[FARC DEBUG] report_states è°ƒç”¨#1: payload_size=1200, arrival_time=1767275110728
[FARC DEBUG] packet_record.packet_num=1
[FARC DEBUG] report_states è°ƒç”¨#2: payload_size=975, arrival_time=1767275110729
[FARC DEBUG] packet_record.packet_num=2

[FARC DEBUG] === get_estimated_bandwidth è°ƒç”¨#1 ===
[FARC DEBUG] å½“å‰packet_num=5
[FARC DEBUG] å½“å‰bandwidth_prediction=1000000
[FARC DEBUG] ç½‘ç»œç»Ÿè®¡: receiving_rate=8000000 bps, delay=50.23 ms, loss_ratio=0.0100
[FARC DEBUG] è§‚å¯Ÿå‘é‡: shape=(150,), min=0.00, max=8000000.00, mean=533333.33
[FARC DEBUG] å¼€å§‹æ¨¡å‹æ¨ç†...
[FARC DEBUG] æ¨¡å‹è¾“å‡º: action.shape=(1, 1, 2), action[0,0]=[8183678. 3456789.]
[FARC DEBUG] åŸå§‹é¢„æµ‹å€¼: 8183678 bps (8.18 Mbps)
[FARC DEBUG] é™åˆ¶åé¢„æµ‹å€¼: 8183678 bps (8.18 Mbps)
[FARC DEBUG] è¿”å›å¸¦å®½ä¼°è®¡: 8183678 bps
```

## æ–¹æ³• 2ï¼šç›´æ¥æŸ¥çœ‹ Docker æ—¥å¿—

### 2.1 è¿è¡Œæ—¶æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
# åœ¨ä¸€ä¸ªç»ˆç«¯è¿è¡Œ
python3 demo.py

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æŸ¥çœ‹ Docker æ—¥å¿—
docker logs -f <container_name>
```

### 2.2 æŸ¥æ‰¾å®¹å™¨åç§°
```bash
docker ps -a | grep pyrtc
```

### 2.3 è¿›å…¥ Docker å®¹å™¨è°ƒè¯•
```bash
# è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨
docker exec -it <container_name> /bin/bash

# åœ¨å®¹å™¨å†…è®¾ç½®è°ƒè¯•å¹¶è¿è¡Œ
export FARC_DEBUG=1
# è¿è¡Œä½ çš„æµ‹è¯•ç¨‹åº
```

## æ–¹æ³• 3ï¼šä¿®æ”¹ demo.py æ·»åŠ è¯¦ç»†æ—¥å¿—è¾“å‡º

åœ¨ `demo.py` ä¸­æ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—ï¼š

```python
def run_one_scenario(algorithm: str, trace: str):
    configure_env_file(algorithm)
    configure_mahimahi_trace(trace)

    command = ["docker", "compose", "up"]
    print(f"Executing: {command} with algorithm: {algorithm}")
    
    # åˆ›å»ºæ—¥å¿—æ–‡ä»¶
    log_file = f"share/output/trace/{algorithm}_debug.log"
    with open(log_file, "w") as f:
        # ä¿ç•™ stderr è¾“å‡ºåˆ°æ–‡ä»¶
        result = subprocess.run(
            command, 
            check=True, 
            stdout=subprocess.DEVNULL, 
            stderr=f  # è¾“å‡ºåˆ°æ–‡ä»¶
        )
    
    print(f"æ—¥å¿—å·²ä¿å­˜åˆ°: {log_file}")
    
    time.sleep(3)
    command = ["docker", "compose", "down"]
    print(f"Executing: {command} with algorithm: {algorithm}")
    subprocess.run(command, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
```

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šæ¨¡å‹æœªæ­£ç¡®åŠ è½½

**æ£€æŸ¥ç‚¹ï¼š**
```bash
# ç¡®è®¤æ¨¡å‹æ–‡ä»¶å­˜åœ¨
ls -lh share/input/ccalgs/FARC/fast_and_furious_model.onnx

# åº”è¯¥çœ‹åˆ°å¤§çº¦ 400KB çš„æ–‡ä»¶
```

**è°ƒè¯•è¾“å‡ºåº”è¯¥æ˜¾ç¤ºï¼š**
```
[FARC DEBUG] æ¨¡å‹è·¯å¾„: .../fast_and_furious_model.onnx
[FARC DEBUG] æ¨¡å‹æ–‡ä»¶å­˜åœ¨: True
[FARC] æ¨¡å‹åŠ è½½æˆåŠŸï¼
```

### é—®é¢˜ 2ï¼šæ²¡æœ‰æ”¶åˆ°æ•°æ®åŒ…

**æ£€æŸ¥ç‚¹ï¼š**
```
[FARC DEBUG] report_states è°ƒç”¨#1: ...
[FARC DEBUG] report_states è°ƒç”¨#2: ...
```

å¦‚æœæ²¡æœ‰çœ‹åˆ°è¿™äº›è¾“å‡ºï¼Œè¯´æ˜ï¼š
- PacketInfo æ²¡æœ‰æ­£ç¡®ä¼ é€’ç»™ä¼°è®¡å™¨
- æ£€æŸ¥ C++ ç»‘å®šå±‚æ˜¯å¦æ­£ç¡®è°ƒç”¨ Python

### é—®é¢˜ 3ï¼šæ•°æ®åŒ…æ•°é‡ä¸è¶³

**è°ƒè¯•è¾“å‡ºï¼š**
```
[FARC DEBUG] === get_estimated_bandwidth è°ƒç”¨#1 ===
[FARC DEBUG] å½“å‰packet_num=2
[FARC DEBUG] æ•°æ®åŒ…æ•°é‡ä¸è¶³(<5)ï¼Œè¿”å›é»˜è®¤å€¼: 1000000
```

**è§£å†³æ–¹æ³•ï¼š**
- ç¡®ä¿æ¯æ¬¡è°ƒç”¨ `get_estimated_bandwidth()` å‰æ”¶é›†äº†è‡³å°‘ 5 ä¸ªæ•°æ®åŒ…
- è°ƒæ•´ `step_time` å‚æ•°

### é—®é¢˜ 4ï¼šæ¨¡å‹æ¨ç†è¿”å›å¼‚å¸¸å€¼

**è°ƒè¯•è¾“å‡ºï¼š**
```
[FARC DEBUG] åŸå§‹é¢„æµ‹å€¼: 0 bps (0.00 Mbps)
```

**å¯èƒ½åŸå› ï¼š**
1. è¾“å…¥ç‰¹å¾å…¨ä¸º 0
2. æ¨¡å‹æ–‡ä»¶æŸå
3. ç‰¹å¾å½’ä¸€åŒ–é—®é¢˜

**æ£€æŸ¥æ–¹æ³•ï¼š**
```python
# åœ¨ BandwidthEstimator.py ä¸­æ·»åŠ 
debug_print(f"ç‰¹å¾æ£€æŸ¥: receiving_rate={receiving_rate}, delay={delay}, loss_ratio={loss_ratio}")
```

## å¿«é€Ÿæµ‹è¯•

### åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_farc.py`

```python
import os
os.environ['FARC_DEBUG'] = '1'

from share.input.ccalgs.FARC.BandwidthEstimator import Estimator

# åˆ›å»ºä¼°è®¡å™¨
estimator = Estimator()

# æ¨¡æ‹Ÿæ•°æ®åŒ…
for i in range(10):
    packet_stats = {
        "send_time_ms": i * 20,
        "arrival_time_ms": i * 20 + 50,  # 50ms å»¶è¿Ÿ
        "payload_type": 125,
        "sequence_number": i,
        "ssrc": 12345,
        "padding_length": 0,
        "header_length": 12,
        "payload_size": 1200,
    }
    estimator.report_states(packet_stats)
    
    # æ¯3ä¸ªåŒ…ä¼°è®¡ä¸€æ¬¡
    if (i + 1) % 3 == 0:
        bw = estimator.get_estimated_bandwidth()
        print(f"ç¬¬ {i+1} ä¸ªåŒ…å: å¸¦å®½ä¼°è®¡ = {bw} bps ({bw/1e6:.2f} Mbps)")
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
cd /home/wyq/æ¡Œé¢/PyRTC-dev
export FARC_DEBUG=1
python3 test_farc.py
```

## é¢„æœŸç»“æœ

æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥çœ‹åˆ°ï¼š
```
[FARC DEBUG] åˆå§‹åŒ–å®Œæˆ
[FARC DEBUG] report_states è°ƒç”¨#1: ...
[FARC DEBUG] === get_estimated_bandwidth è°ƒç”¨#1 ===
[FARC DEBUG] ç½‘ç»œç»Ÿè®¡: receiving_rate=480000 bps, ...
[FARC DEBUG] åŸå§‹é¢„æµ‹å€¼: 1234567 bps (1.23 Mbps)
[FARC DEBUG] è¿”å›å¸¦å®½ä¼°è®¡: 1234567 bps
ç¬¬ 3 ä¸ªåŒ…å: å¸¦å®½ä¼°è®¡ = 1234567 bps (1.23 Mbps)
```

## è”ç³»ç‚¹

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. å®Œæ•´çš„è°ƒè¯•æ—¥å¿—ï¼ˆè®¾ç½® `FARC_DEBUG=1` åçš„è¾“å‡ºï¼‰
2. `webrtc_FARC.log` æ–‡ä»¶
3. Docker å®¹å™¨æ—¥å¿—
4. æ¨¡å‹æ–‡ä»¶çš„ md5sum

```bash
md5sum share/input/ccalgs/FARC/fast_and_furious_model.onnx
```

